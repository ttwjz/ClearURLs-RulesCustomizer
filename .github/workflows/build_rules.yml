name: Build ClearURLs Rules

on:
    push:
        branches: ["main"]
        paths:
            - "custom_rules.yaml"
            - "script/**"
            - ".github/workflows/**"
            # 注意：不要把 'rules/**' 加在这里，否则会死循环
    schedule:
        - cron: "0 22 * * *" # 每天 UTC 22:00 (北京时间早上7点) 运行
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            # 必须给予写权限才能推送到仓库
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.9"

            - name: Install dependencies
              run: |
                  pip install -r requirements.txt

            - name: Run builder script
              run: |
                  python script/builder.py

            - name: Commit and Push to Main
              run: |
                  # 配置 Git 用户信息（显示为 GitHub Actions Bot）
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  # 添加生成的文件
                  git add rules/

                  # 检查是否有变更
                  if git diff --staged --quiet; then
                    print("No changes to commit.")
                  else
                    # 提交并推送
                    # [skip ci] 是个双重保险，告诉 Github 这次提交不要触发 CI
                    git commit -m "Auto-update rules [skip ci]"
                    git push
                  fi
