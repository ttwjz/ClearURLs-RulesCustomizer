name: Build ClearURLs Rules

on:
  push:
    branches: ["main"]
    paths:
      - "custom_rules.yaml"
      - "script/**"
      - ".github/workflows/**"
      # æ³¨æ„ï¼šä¸è¦æŠŠ 'rules/**' åŠ åœ¨è¿™é‡Œï¼Œå¦åˆ™ä¼šæ­»å¾ªç¯
  schedule:
    - cron: "0 22 * * *" # æ¯å¤© UTC 22:00 (åŒ—äº¬æ—¶é—´æ—©ä¸Š7ç‚¹) è¿è¡Œ
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      # å¿…é¡»ç»™äºˆå†™æƒé™æ‰èƒ½æ¨é€åˆ°ä»“åº“
      contents: write
    # é¿å…å¹¶å‘æ‰§è¡Œ
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # pip install flake8 pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      # - name: Lint with flake8
      #   run: |
      #     # stop the build if there are Python syntax errors or undefined names
      #     flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      #     # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
      #     flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Build rules
        run: |
          python script/builder.py
          # å°† main åˆ†æ”¯å‡†å¤‡å¥½çš„ README å¤åˆ¶åˆ°è¾“å‡ºç›®å½•ï¼Œå¹¶é‡å‘½å
          cp GHPAGES_README.md rules/README.md

      # --- æ–°å¢æ­¥éª¤ï¼šæ™ºèƒ½å›æ»šæ—¥å¿— ---
      - name: Check for changes and restore log if needed
        shell: bash
        run: |
          # 1. è·å– gh-pages åˆ†æ”¯çš„æœ€æ–°çŠ¶æ€ (å¿½ç•¥é”™è¯¯ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡è¿è¡Œæ—¶åˆ†æ”¯å¯èƒ½ä¸å­˜åœ¨)
          git fetch origin gh-pages --depth=1 || true

          # 2. æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            echo "Comparing generated hash with deployed hash..."

            # è¯»å–æœ¬åœ°æ–°ç”Ÿæˆçš„ hash
            NEW_HASH=$(cat rules/rules.min.hash)
            
            # è¯»å–è¿œç¨‹ gh-pages åˆ†æ”¯æ ¹ç›®å½•ä¸‹çš„ hash æ–‡ä»¶
            # æ³¨æ„ï¼šæ–‡ä»¶åœ¨è¿œç¨‹æ˜¯ä½äºæ ¹ç›®å½•çš„
            OLD_HASH=$(git show origin/gh-pages:rules.min.hash 2>/dev/null || echo "none")

            echo "Local Hash:  $NEW_HASH"
            echo "Remote Hash: $OLD_HASH"

            if [ "$NEW_HASH" == "$OLD_HASH" ]; then
              echo "âœ… Rules are identical. Restoring old log to prevent Git commit."
              # ä»è¿œç¨‹è¯»å–æ—§æ—¥å¿—ï¼Œè¦†ç›–æœ¬åœ°çš„æ–°æ—¥å¿—
              git show origin/gh-pages:merge_log.txt > rules/merge_log.txt
            else
              echo "ğŸš€ Rules have changed. Keeping new log for commit."
            fi
          else
            echo "Branch gh-pages does not exist yet. Skipping comparison."
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # ã€å…³é”®é…ç½®ã€‘
          # publish_dir: æŒ‡å®šè¦å‘å¸ƒçš„æ–‡ä»¶å¤¹ã€‚
          # æ’ä»¶ä¼šå°† rules/ æ–‡ä»¶å¤¹é‡Œçš„å†…å®¹ï¼Œæ¨é€åˆ° gh-pages åˆ†æ”¯çš„ã€æ ¹ç›®å½•ã€‘ã€‚
          publish_dir: ./rules

          # publish_branch: æ¨é€åˆ°å“ªä¸ªåˆ†æ”¯ï¼Œé»˜è®¤æ˜¯ gh-pages
          publish_branch: gh-pages

          # commit_message: è‡ªå®šä¹‰æäº¤ä¿¡æ¯
          commit_message: "Auto-update rules ${{ github.sha }}"

          # user_name / user_email: è®¾ç½®æäº¤æœºå™¨äººä¿¡æ¯
          user_name: "github-actions[bot]"
          user_email: "41898282+github-actions[bot]@users.noreply.github.com"

          # force_orphan: (å¯é€‰) å¦‚æœè®¾ä¸º trueï¼Œæ¯æ¬¡éƒ½ä¼šæŠŠ gh-pages åˆ†æ”¯æ¸…ç©ºé‡å»ºï¼Œä¿æŒè¯¥åˆ†æ”¯åªæœ‰ 1 ä¸ª commit
          # å¦‚æœä½ æƒ³ä¿ç•™å†å²è®°å½•ï¼ˆæ¯”å¦‚æƒ³çœ‹ log å†å²ï¼‰ï¼Œå°±è®¾ä¸º false (é»˜è®¤)
          force_orphan: false

      # - name: Commit and Push to Main
      #   run: |
      #     # 1. é…ç½® Git ç”¨æˆ·
      #     git config --global user.name "github-actions[bot]"
      #     git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      #     # 2. ã€å…³é”®ã€‘å…ˆåªæ·»åŠ å®è´¨æ€§çš„æ•°æ®æ–‡ä»¶ (JSON å’Œ Hash)
      #     # æ³¨æ„ï¼šä¸è¦æ·»åŠ  rules/merge_log.txt
      #     git add rules/*.json rules/*.hash

      #     # 3. æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰å˜æ›´
      #     if git diff --staged --quiet; then
      #       echo "No rules changed. Skipping commit."
      #       # è§„åˆ™æ²¡å˜ï¼ŒLog é‡Œçš„æ—¶é—´å˜äº†ä¹Ÿæ²¡æ„ä¹‰ï¼Œç›´æ¥ç»“æŸï¼Œä¸æäº¤
      #     else
      #       echo "Rules changed. Committing..."

      #       # 4. è§„åˆ™ç¡®å®å˜äº†ï¼Œç°åœ¨æŠŠ Log ä¹ŸåŠ å…¥æš‚å­˜åŒºï¼Œä½œä¸ºæœ¬æ¬¡å˜æ›´çš„è¯´æ˜
      #       git add rules/merge_log.txt

      #       # 5. æäº¤å¹¶æ¨é€
      #       git commit -m "Auto-update rules [skip ci]"
      #       git push
      #     fi
